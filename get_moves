def get_moves(fen):
      global player_turn
      board = fen_to_board(fen)
      ep = 0
      kp = 0
      for i, p in enumerate(board):
            if not p.isupper(): continue
            for d in directions[p]:
                for j in count(i+d, d):
                    q = board[j]
                    # Stay inside the board, and off friendly pieces
                    if q.isspace() or q.isupper(): break
                    # Pawn move, double move and capture
                    if p == 'P' and d in (N, N+N) and q != '.': break
                    if p == 'P' and d == N+N and (i < A1+N or board[i+N] != '.'): break
                    if p == 'P' and d in (N+W, N+E) and q == '.' and j not in (ep, kp): break
                    # Move it
                    yield (i, j)
                    # Stop crawlers from sliding, and sliding after captures
                    if p in 'PNK' or q.islower(): break
